---
title: "Thesis Data Viz"
author: "Ryan Calhoun & Nicholas Paterna"
date: "6/3/2021"
output: 
  html_document:
    theme: paper
    highlight: zenburn
    center: TRUE
editor_options: 
  
  chunk_output_type: console
---

```{r setup, include=FALSE, fig.align = "center"}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(RColorBrewer)
library(lattice)
library(patchwork)
library(corrplot)
library(MQMF)

setwd("/Users/Caronelab/Desktop/Spicy_Pepper_Project/R_Workflow")
#setwd("/Users/nickpaterna/Repositories/Spicy_Pepper_Project/R_Workflow")

```

## Loading in Raw Data
  Here we imported **all** of the raw data before _tidying_ it. All functions were performed utilizing the default **Tidyverse** package!
  
```{r Loading in Data}

genes_fpkm <- read_csv("genes_fpkm.csv") #Reading in FPKM Values
protein_data <- read_csv("Spicy_Pepper_cufflinks_information.csv") #Pepper info

```

## Tidying the Raw Data

```{r Tidying the Data}

tidy_fpkm <- genes_fpkm %>%
  pivot_longer(cols = 4:51,
               names_to = "Sample_ID",
               values_to = "FPKM") #Shrink dataframe width by creating 'Sample ID' col

final_tidy <- tidy_fpkm %>%
  full_join(protein_data,
             by = "Sample_ID") %>%
  rename(c(Locus = locus,
           Gene_ID = genes_fpkm_with_protein_charact)) 
#Add pepper information to tidied dataset, rename cols to make working w data easier

trimmed_tidy <- final_tidy %>%
  mutate(Sample_ID = str_sub(Sample_ID, 1, -5)) %>% #Shrinks sample name
  mutate(Forward = str_detect(Sample_ID, "R1")) %>% #Logic output for direction
  mutate(Direction = case_when(Forward == TRUE ~ "Forward",
                               Forward == FALSE ~ "Reverse")) %>%
  select(-Forward) %>% #Removes logic col now that we have actual direction
  mutate(Sample_ID = str_sub(Sample_ID,1, 5))

```

##Creating bar graph of Mapped Libraries
  Creating a bar graph to visualize the different size of mapped reads across the samples

```{r Bar Graph of Mapped Reads}

  trimmed_tidy %>%
  filter(Direction == "Forward") %>% #Removes duplicate libraries
  ggplot(aes(x = Sample_ID, y = Mapped_Reads, fill = Pepper_Name)) +
  geom_col() + theme_bw() +
  scale_fill_brewer(palette = "Accent") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(x = "Sample ID",
       y = "Mapped Reads",
       fill = "Pepper Name",
       title = "Mapped Reads per Sample")
  

```


##Creating Box Plot of FPKM values
##Creating a box plot to visualize the FPKM values plotted against their Sample IDs

```{r Box Plot of FPKM values}

trimmed_tidy %>%
  select(Sample_ID, FPKM, Pepper_Name) %>%
  mutate(Log2_Trans = log2(FPKM)) %>%
  ggplot(aes(x=Sample_ID, y=Log2_Trans, fill = Pepper_Name, color = Pepper_Name)) +
  geom_boxplot(alpha = 0.5) +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2",
                    guide = "none") +
  scale_color_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(x = "Sample ID",
       y = "FPKM",
       fill = "Pepper Name",
       title = "Log2 Transformartion of FPKM per Sample")


```

##Creating PCAs for Pepper Samples

```{r Attempting to Create a Naming Function, echo = FALSE}

splom_object %>%
  select(-Gene_ID) %>%
  colnames() -> pepper_columns

naming_function <- function()
{

  if(str_detect(pepper_columns, "Hab")){
  print("Habanero")
} else if (str_detect(pepper_columns, "Jal")){
  print("Jalapeno")
} else if (str_detect(pepper_columns, "Ser")){
  print("Serrano")
} else if (str_detect(pepper_columns, "Wax")){
  print("Hungarian Wax")
} else if (str_detect(pepper_columns, "Che")){
  print("Cherry")
} else if (str_detect(pepper_columns, "Gho")){
  print("Ghost")
} else {print("Cayenne")}
}

```



```{r PCA of Pepper Samples}

#### Using dplyr to manipulate the data we have into a format we want ####
pre_pca <- genes_fpkm %>%
  pivot_longer(cols = 4:51,
               names_to = "Sample_ID",
               values_to = "FPKM") %>%
  mutate(FPKM = ifelse(FPKM == 0, 1, FPKM), 
         FPKM_log2 = log2(FPKM)) %>%
  mutate(Sample_ID = str_sub(Sample_ID, 1, -5)) %>%
  rename(Gene_ID = genes_fpkm_with_protein_charact) %>%
  select(c(-Protein_Function, -locus, -FPKM)) %>%
  pivot_wider(names_from = Gene_ID,
              values_from = FPKM_log2)

#### Running the PCA ####
pre_pca %>%
  select(-Sample_ID) %>%
  scale() %>% #Normalizes data for clustering
  prcomp() -> pepper_pca

#### Plotting PC1 v PC2 ####
as_tibble(pepper_pca$x) %>% #Generates table
  mutate(Sample_ID = pre_pca$Sample_ID) %>%
  ggplot(aes(x = PC1, y = PC2, color = Pepper_Name)) +
  geom_point(size = 0.5,
             alpha=0.5) +
  theme_bw() + 
  facet_wrap(~Pepper_Name)

#### Plotting PC1 v PC3 ####
as_tibble(pepper_pca$x) %>% #Generates table
  mutate(Tissue = ifelse(str_detect(Sample_ID, "P"), "Placenta", "Skin")) %>%
  mutate(Direction = ifelse(str_detect(Sample_ID, "R1"), "Forward", "Reverse")) %>%
  ggplot(aes(x = PC1, y = PC3, color = Tissue)) +
  geom_point() + theme_bw()

#### Plotting PC2 v PC3 ####
as_tibble(pepper_pca$rotation) %>% #Generates table
  mutate(Tissue = ifelse(str_detect(Sample_ID, "P"), "Placenta", "Skin")) %>%
  mutate(Direction = ifelse(str_detect(Sample_ID, "R1"), "Forward", "Reverse")) %>%
  ggplot(aes(x = PC2, y = PC3, color = Direction)) +
  geom_point() + theme_bw()

  
#### Creating a Scree Plot to show PC variation ####
  var_explained = pepper_pca$sdev^2 / sum(pepper_pca$sdev^2) #Defining the amount of variation explained by each PC


  qplot(c(1:48), var_explained) + #Using qplot to quickly select info out of a value
  geom_line() + 
  xlab("Principal Component") + 
  ylab("Variance Explained") +
  ggtitle("Scree Plot") +
  ylim(0, 1) +
  theme_bw()

```

##Creating Scatterplot of FPKM Values

Creating a scatter plot that plots the FPKM values for a forward run sample against its reverse run counterpart

```{r Scatterplot of FPKM values}

splom_object <- genes_fpkm %>%
  pivot_longer(cols = 4:51,
               names_to = "Sample_ID",
               values_to = "FPKM") %>%
  mutate(FPKM = ifelse(FPKM == 0, 1, FPKM), 
         FPKM_log2 = log2(FPKM)) %>%
  mutate(Sample_ID = str_sub(Sample_ID, 1, -5)) %>%
  rename(Gene_ID = genes_fpkm_with_protein_charact) %>%
  select(c(-Protein_Function, -locus, -FPKM)) %>%
  pivot_wider(names_from = Sample_ID,
              values_from = FPKM_log2) %>%
  rename(HabP1_R1 = HabP1_R1,
HabP1_R2 = HabP1_R2,
JalP1_R1 = JalP1_R1, 
JalP1_R2 = JalP1_R2,
SerP1_R1 = SerP1_R1,
SerP1_R2 = SerP1_R2,
WaxP1_R1 = WaxP1_R1,
WaxP1_R2 = WaxP1_R2,
CheP1_R1 = CheP1.LCL3435_L3_R1,
CheP1_R2 = CheP1.LCL3435_L3_R2,
CheP2_R1 = CheP2.LCL3437_L3_R1,
CheP2_R2 = CheP2.LCL3437_L3_R2,
CheS1_R1 = CheS1.LCL3434_L3_R1,
CheS1_R2 = CheS1.LCL3434_L3_R2,
CheS2_R1 = CheS2.LCL3436_L3_R1,
CheS2_R2 = CheS2.LCL3436_L3_R2,
GhoP1_R1 = GhoP1.LCL3453_L3_R1,
GhoP1_R2 = GhoP1.LCL3453_L3_R2,
GhoS1_R1 = GhoS1.LCL3452_L3_R1,
GhoS2_R2 = GhoS1.LCL3452_L3_R2,
HabP2_R1 = HabP2.LCL3451_L3_R1,
HabP2_R2 = HabP2.LCL3451_L3_R2,
HabS1_R1 = HabS1.LCL3448_L3_R1,
HabS1_R2 = HabS1.LCL3448_L3_R2,
HabS2_R1 = HabS2.LCL3450_L3_R1,
HabS2_R2 = HabS2.LCL3450_L3_R2,
JalS1_R1 = JalS1.LCL3442_L3_R1,
JalS1_R2 = JalS1.LCL3442_L3_R2,
CayP2_R1 = CayP2.LCL3431_L3_R1,
CayP2_R2 = CayP2.LCL3431_L3_R2,
CayP3_R1 = CayP3.LCL3433_L3_R1,
CayP3_R2 = CayP3.LCL3433_L3_R2,
CayS1_R1 = CayS1.LCL3430_L3_R1,
CayS1_R2 = CayS1.LCL3430_L3_R2,
CayS3_R1 = CayS3.LCL3432_L3_R1,
CayS3_R2 = CayS3.LCL3432_L3_R2,
SerP2_R1 = SerP2.LCL3447_L3_R1,
SerP2_R2 = SerP2.LCL3447_L3_R2,
SerS1_R1 = SerS1.LCL3444_L3_R1,
SerS1_R2 = SerS1.LCL3444_L3_R2,
SerS2_R1 = SerS2.LCL3446_L3_R1,
SerS2_R2 = SerS2.LCL3446_L3_R2,
WaxP2_R1 = WaxP2.LCL3441_L3_R1,
WaxP2_R2 = WaxP2.LCL3441_L3_R2,
WaxS1_R1 = WaxS1.LCL3438_L3_R1,
WaxS1_R2 = WaxS1.LCL3438_L3_R2,
WaxS2_R1 = WaxS2.LCL3440_L3_R1,
WaxS2_R2 = WaxS2.LCL3440_L3_R2)



Che_scatter <- splom(splom_object[c(9,10,11,12,13,14,15,16)],
                       par.settings = simpleTheme(col="darkseagreen4"),
                       pch = 20)

Hab_scatter <- splom(splom_object[c(1,2,21,22,23,24,25,26)],
                       par.settings = simpleTheme(col="goldenrod1"),
                       pch = 20)
  
  
  # splom(splom_object[c(4,5,28,29)],
  #       par.settings =simpleTheme(col="magenta4"),
  #       upper.panel = panel.cor, #Removes upper scatterplot
  #       varname.cex = 0.95, #changes pepper name size
  #       axis.text.cex = 0.65, #changes axis size
  #       xlab= "Jalapeno FPKM values", #x-axis label
  #       ylab= "Jalapeno FPKM values", #y-axis label
  #       pscales = 5, #number of equally spaced ticks on plot
  #       axis.line.lty = 3,
  #       px.scatter = TRUE,
  #       horizontal=TRUE,
  #       pch = ".")

  
splom_object %>%
  select(starts_with("Jal")) %>% #Identifies pepper sample by name
  pairs(upper.panel = panel.cor, #Replaces upper panel scatterplots with r-squared values
        font.labels = 2, #changes sample label size
        main = "Jalapeno FPKM values", #graph title
        pch = ".", #graph point size
        col = "magenta4") #changes point color

splom_object %>%
  select(starts_with("Ser")) %>% #Identifies pepper sample by name
  pairs(upper.panel = panel.cor, #Replaces upper panel scatterplots with r-squared values
        font.labels = 2, #changes sample label size
        main = "Serrano FPKM values", #graph title
        pch = ".", #graph point size
        col = "magenta4") #changes point color



 # # Gho_scatter <- splom(splom_object[c(17,18,19,20)],
 #                       par.settings = simpleTheme(col="sienna"),
 #                       pch = 20)
 #  
 #  Wax_scatter <- splom(splom_object[c(7,8,43,44,45,46,47,48)],
 #                       par.settings = simpleTheme(col="deeppink4"),
 #                       pch = 20)
 #  
 #  Cay_scatter <- splom(splom_object[c(29,30,31,32,33,34,35,36)],
 #                       par.settings = simpleTheme(col="burlywood4"),
 #                       pch = 20)
 # delete me
```

##Creating HeatMap for Pepper samples

Creating a heatmap to show the top highly expressed genes utilizing their FPKM values

```{r HeatMap of FPKM values}


```



###Corrplot for Pepper Samples

```{r Corrplot}

#Creating Ryan's color palettes for the scale
ryan_pal <- colorRampPalette(c("#7FD1B9", "#AAE5D3", "#CEF0E6", "#E7F6F7"))
ryan_pal2 <- colorRampPalette(c("#E7F6F7", "#CEF0E6", "#AAE5D3", "#7FD1B9"))
ryan_pal3 <- colorRampPalette(c( "#84dcc6","#d6edff","#acd7ec","#8b95c9","#478978"))

splom_object %>%
  select(-c(1:3)) %>%
  cor() %>%
  corrplot(order = "hclust", #Specifies how we arrange data
           method = "square", #Presentation of clusters
           addrect = 8, #Distinguishes groups among clusters
           rect.col = "magenta4", #Color of groups
           tl.cex = 0.75, #Label size
           tl.col = "black", #Label colors
           tl.srt = 45, #Angle of labels - TOP
           bg = "white", #Background color
           cl.lim = c(0,1), #Range of the scale
           cl.ratio = 0.1, #Scale size
           cl.cex = 1, #Scale number size
           is.corr = F, #Whether the range affects the chosen colors
           col = ryan_pal3(6)) #Specifies color palette

```





